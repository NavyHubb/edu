## Master Node 구성 

```
1. Swap off
   o Swap 정보 확인 : swapon --show=NAME,SIZE,USED,PRIO
   $> swapoff -a

2. RKE2 설치 (Control node 설치)
   참고 : https://docs.rke2.io/install/quickstart

    a. 설치
       $> curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="server" sh -

3. RKE2 서버 실행
   $> systemctl enable rke2-server.service
   $> systemctl start rke2-server.service
   $> systemctl status rke2-server.service

   $> systemctl stop rke2-server.service


4. kubectl 실행 Path 설정 
   $> mkdir ~/.kube
   $> cp -p /etc/rancher/rke2/rke2.yaml ~/.kube/config 


5. kubectl 환경 설정
   $> echo 'export PATH=/usr/local/bin:/var/lib/rancher/rke2/bin:$PATH' >> ~/.bashrc
```

![Master Node 생성](/lecture0-클러스터 구성/img/lecture0-rke2-master01.png)

## Worker Node 구성

```
1. Swap off
   $> swapoff -a

2. RKE2 설치 (Control node 설치)
   참고 : https://docs.rke2.io/install/quickstart
 
    a. 설치 : 마스터와의 차이는 INSTALL_RKE2_TYPE="agent" 
       $> curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE="agent" sh -

3. Worker Node 인증 설정
   ## Master Node 인증 토큰 확인 : Master Node 실행 
   $> cat /var/lib/rancher/rke2/server/node-token

   ## Worker Node 설정 : root
   $> mkdir -p /etc/rancher/rke2/
   $> vi /etc/rancher/rke2/config.yaml
     ## 다음 내용 입력
        server: https://<server 사설 IP>:9345
        token: <token from server node>
      ------ 예시 
        server: https://172.27.0.179:9345
        token: K1076de2bb1e966528fb384f6368a6f2f0946d9e40d45ae820de9392e8ff242014d::server:d7458fc1730173ced292055b9d559e10

4. Start Agent Service
   $> systemctl enable rke2-agent.service
   $> systemctl start rke2-agent.service
   $> systemctl status rke2-agent.service

   $> systemctl stop rke2-agent.service

   # 로그 확인 
   $> journalctl -u rke2-agent -f
  
```
![Worker Node 생성](/lecture0-클러스터 구성/img/lecture0-rke2-worker02.png)

o Master Node 토큰 확인

![Master Node 토큰](/lecture0-클러스터 구성/img/lecture0-rke2-worker01-token.png)

o Worker Node 서버 접속 Config

![Worker Node 서버 접속 Config](/lecture0-클러스터 구성/img/lecture0-rke2-worker01-config.png)

## Node Join 확인

```
위치: Master Node에서
   $> kubectl get nodes 

   # kubectl: command not found 일때 아래 실행 후 노드 조인 확인
   $> source  ~/.bashrc 
```
![Worker Node 서버 접속 Config](/lecture0-클러스터 구성/img/lecture0-node-join.png)

## Master Node에 신규 Pod 생성 제한

```
위치: Master Node에서
   $> kubectl taint nodes master01 node-role.kubernetes.io/master=:NoSchedule

   # 설정 확인
   $> kubectl describe node master01
```

## k9s 설치

```
위치: Master Node에서
   $> mkdir -p /tmp/k9s
   $> cd /tmp/k9s
   $> K9S_VERSION=v0.32.5
   $> curl -sL https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz | sudo tar xfz - -C /usr/local/bin k9s
   
   $> vi ~/.bashrc
      export KUBECONFIG=$HOME/.kube/config
   $> source ~/.bashrc; k9s

```

``` k9s_install.sh
echo "=====k9s settings======="
mkdir -p /tmp/k9s
cd /tmp/k9s
K9S_VERSION=v0.32.7
curl -sL https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz | sudo tar xfz - -C /usr/local/bin k9s

export KUBECONFIG=/root/.kube/config
echo 'export KUBECONFIG=/root/.kube/config' >> ~/.bashrc
source ~/.bashrc; k9s

```


## NFS 설치

```
# NFS 서버 추가 
  - 이름 : nfs01, 용량: 300G, 볼륨 마운트 : /host
  
# 서버 구성 : Master Node 
      $> sudo apt update
      $> sudo apt-get install nfs-kernel-server
      $> mkdir -p /mnt/sdb/nfs
      $> sudo chown -R ec2-user:ec2-user /mnt/efs
         sudo chown -R ec2-user:ec2-user /data

      $> sudo vi /etc/exports
         [예시] /datafolder 192.168.0.0/16(rw,sync,no_subtree_check,no_root_squash)
         /mnt/sdb/nfs 172.27.0.0/24(rw,sync,no_subtree_check,no_root_squash)
        /data/host 10.1.156.5/24(rw,sync,no_subtree_check,no_root_squash)


      $> sudo /usr/sbin/exportfs -a or sudo /usr/sbin/exportfs -r
      $> sudo systemctl restart nfs-kernel-server.service

      $> sudo systemctl restart nfs-kernel-server.service

      
   $> sudo systemctl enable nfs-kernel-server.service
   $> sudo systemctl stop nfs-kernel-server.service
   $> sudo systemctl start nfs-kernel-server.service
   $> sudo systemctl status nfs-kernel-server.service


      ## Client 구성 : Worker Node 
      $> sudo apt update
      $> sudo apt install nfs-common

      ## nfs 마운트 가능 스토리지 조회 (서버 IP 변경)
      $> showmount -e 10.1.156.5
      

      ## 마운트
      $> sudo mkdir -p /data/host
      $> sudo mount 10.1.156.5:/data/host /data/host 

      ## 재부팅 후 nfs 자동 마운트 
      $> sudo vi /etc/fstab 
      10.1.156.5:/data/host    /data/host    nfs    defaults    0 0 
```